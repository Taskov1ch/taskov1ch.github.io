<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Викторина: Страны и Столицы</title>
    <style>
        /* --- Стили остаются без изменений --- */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
        :root { --bg-color: #12121f; --primary-color: #1e1e3f; --secondary-color: #2c2c54; --accent-color: #ff4757; --text-color: #f5f6fa; --correct-color: #4cd137; --incorrect-color: #e84118; --font-family: 'Montserrat', sans-serif; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; overflow: hidden; }
        .container { width: 100%; max-width: 800px; background-color: var(--primary-color); border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); position: relative; overflow: hidden; border: 2px solid var(--secondary-color); }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; animation: fadeIn 0.5s ease-in-out; }
        .screen.active { display: flex; }
        h1 { font-size: 2.5rem; margin-bottom: 1rem; color: var(--accent-color); } h2 { font-size: 2rem; margin-bottom: 2rem; } p { font-size: 1.2rem; margin-bottom: 2rem; line-height: 1.6; }
        .button { background: linear-gradient(145deg, var(--accent-color), #c4303e); color: var(--text-color); border: none; padding: 1rem 2rem; font-size: 1.2rem; font-weight: 600; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        .button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(255, 71, 87, 0.5); }
        .button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }
        #name-input { font-family: var(--font-family); font-size: 1.2rem; width: 80%; max-width: 400px; padding: 0.8rem; margin-bottom: 1.5rem; border-radius: 8px; border: 2px solid var(--secondary-color); background-color: var(--bg-color); color: var(--text-color); text-align: center; }
        #name-input:focus { outline: none; border-color: var(--accent-color); }
        #name-input.input-error { animation: shake 0.5s ease-in-out; border-color: var(--incorrect-color); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        #quiz-screen { width: 100%; justify-content: flex-start; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .header-item { background-color: var(--secondary-color); padding: 0.5rem 1rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; min-width: 120px; text-align: center; }
        #question-counter { color: var(--accent-color); }
        .timer-container { width: 100%; height: 10px; background-color: var(--secondary-color); border-radius: 5px; margin-bottom: 2rem; overflow: hidden; }
        #timer-bar { height: 100%; width: 100%; background: linear-gradient(90deg, var(--correct-color), #a2ff9b); border-radius: 5px; }
        .timer-animated { transition: width 10s linear; }
        #question-text { font-size: 1.8rem; margin-bottom: 2rem; font-weight: 600; min-height: 80px; }
        .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; margin-bottom: 2rem; }
        .answer-btn { background-color: var(--secondary-color); border: 2px solid transparent; color: var(--text-color); padding: 1rem; font-size: 1.1rem; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; min-height: 70px; display: flex; justify-content: center; align-items: center; }
        .answer-btn:hover:not(:disabled) { border-color: var(--accent-color); transform: translateY(-2px); }
        .answer-btn.correct { background-color: var(--correct-color); border-color: var(--correct-color); color: #fff; animation: pulse 0.5s; }
        .answer-btn.incorrect { background-color: var(--incorrect-color); border-color: var(--incorrect-color); color: #fff; }
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .quiz-footer { margin-top: 1rem; }
        #end-quiz-btn { background: #6a6a6a; }
        #end-quiz-btn:hover { background: #808080; box-shadow: 0 4px 15px rgba(128, 128, 128, 0.3); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); } }
        .shake { animation: shake 0.5s ease-in-out; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; opacity: 0; animation: confetti-fall 2s ease-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-100px) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotateZ(720deg); opacity: 0; } }
        #final-screen h2 { font-size: 2.5rem; margin-bottom: 1rem; }
        .stats { display: flex; justify-content: space-around; width: 100%; margin: 2rem 0; flex-wrap: wrap; gap: 1rem; }
        .stat-item { background-color: var(--secondary-color); padding: 1.5rem; border-radius: 12px; flex-basis: 200px; flex-grow: 1; }
        .stat-item h3 { font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--accent-color); }
        .stat-item p { font-size: 2rem; font-weight: 700; margin: 0; }
        #cutscene-screen, #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 100; }
        #loading-message { font-size: 2rem; }
        @keyframes rainbow-text { 0% { color: hsl(0, 100%, 60%); } 15% { color: hsl(50, 100%, 60%); } 30% { color: hsl(120, 100%, 60%); } 45% { color: hsl(180, 100%, 60%); } 60% { color: hsl(240, 100%, 60%); } 75% { color: hsl(290, 100%, 60%); } 100% { color: hsl(360, 100%, 60%); } }
        @keyframes levitate { 0%, 100% { transform: translateY(0) translateX(0) rotate(0); } 25% { transform: translateY(-5px) translateX(3px) rotate(-1deg); } 75% { transform: translateY(5px) translateX(-3px) rotate(1deg); } }
        #score-counter { font-size: 8vw; font-weight: 700; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); animation: rainbow-text 5s linear infinite, levitate 8s ease-in-out infinite; }
        #fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 101; pointer-events: none; }
        .firework { position: absolute; width: 4px; height: 4px; background-color: white; border-radius: 50%; }
        .spark { position: absolute; width: 3px; height: 3px; border-radius: 50%; }
        @media (max-width: 768px) { .container { padding: 1.5rem; } h1 { font-size: 2rem; } h2 { font-size: 1.8rem; } .answers-grid { grid-template-columns: 1fr; } .quiz-header { flex-direction: column; gap: 0.5rem; } #question-text { font-size: 1.5rem; min-height: 60px; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="start-screen" class="screen active"><h1>Страны и Столицы</h1><p>Добро пожаловать! Введите ваше имя, чтобы начать.</p><input type="text" id="name-input" placeholder="Ваше имя"><button id="start-btn" class="button">Начать игру</button></div>
        <div id="quiz-screen" class="screen"><div class="quiz-header"><div class="header-item">Вопрос: <span id="question-counter">1/134</span></div><div class="header-item">Очки: <span id="score">0</span></div><div class="header-item">Комбо: <span id="combo">x1</span></div></div><div class="timer-container"><div id="timer-bar"></div></div><h2 id="question-text">Какая столица у этой страны?</h2><div class="answers-grid"><button class="answer-btn"></button><button class="answer-btn"></button><button class="answer-btn"></button><button class="answer-btn"></button></div><div class="quiz-footer"><button id="end-quiz-btn" class="button">Завершить</button></div></div>
        <div id="final-screen" class="screen"><h2>Игра окончена!</h2><div class="stats"><div class="stat-item"><h3>Итоговый счёт</h3><p id="final-score">0</p></div><div class="stat-item"><h3>Лучшее комбо</h3><p id="max-combo">x0</p></div><div class="stat-item"><h3>Точность</h3><p id="accuracy">0%</p></div></div><button id="restart-btn" class="button">Играть снова</button></div>
    </div>
    <div id="loading-screen" class="screen"><h2 id="loading-message">Загрузка...</h2></div>
    <div id="cutscene-screen" class="screen"><div id="score-counter">0</div></div>
    <div id="fireworks-container"></div>
    <audio id="final-music" src="final_music.mp3" preload="auto"></audio><audio id="quiz-music" src="quiz_music.mp3" preload="auto" loop></audio><audio id="correct-sound" src="correct_sound.mp3" preload="auto"></audio><audio id="incorrect-sound" src="incorrect_sound.mp3" preload="auto"></audio>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const questions = [
            { country: 'Ирландия', capital: 'Дублин' }, { country: 'Нидерланды', capital: 'Амстердам' }, { country: 'Бельгия', capital: 'Брюссель' }, { country: 'Люксембург', capital: 'Люксембург' }, { country: 'Монако', capital: 'Монако' }, { country: 'Австрия', capital: 'Вена' }, { country: 'Лихтенштейн', capital: 'Вадуц' }, { country: 'Швейцария', capital: 'Берн' }, { country: 'Белоруссия (Беларусь)', capital: 'Минск' }, { country: 'Польша', capital: 'Варшава' }, { country: 'Чехия', capital: 'Прага' }, { country: 'Словакия', capital: 'Братислава' }, { country: 'Венгрия', capital: 'Будапешт' }, { country: 'Молдавия (Молдова)', capital: 'Кишинёв' }, { country: 'Румыния', capital: 'Бухарест' }, { country: 'Болгария', capital: 'София' }, { country: 'Португалия', capital: 'Лиссабон' }, { country: 'Испания', capital: 'Мадрид' }, { country: 'Андорра', capital: 'Андорра-ла-Велья' }, { country: 'Сан-Марино', capital: 'Сан-Марино' }, { country: 'Мальта', capital: 'Валлетта' }, { country: 'Словения', capital: 'Любляна' }, { country: 'Хорватия', capital: 'Загреб' }, { country: 'Босния и Герцеговина', capital: 'Сараево' }, { country: 'Сербия', capital: 'Белград' }, { country: 'Черногория', capital: 'Подгорица' }, { country: 'Македония', capital: 'Скопье' }, { country: 'Албания', capital: 'Тирана' }, { country: 'Греция', capital: 'Афины' }, { country: 'Дания', capital: 'Копенгаген' }, { country: 'Исландия', capital: 'Рейкьявик' }, { country: 'Финляндия', capital: 'Хельсинки' }, { country: 'Швеция', capital: 'Стокгольм' }, { country: 'Норвегия', capital: 'Осло' }, { country: 'Эстония', capital: 'Таллин' }, { country: 'Латвия', capital: 'Рига' }, { country: 'Литва', capital: 'Вильнюс' }, { country: 'Грузия', capital: 'Тбилиси' }, { country: 'Абхазия', capital: 'Сухум' }, { country: 'Южная Осетия', capital: 'Цхинвал' }, { country: 'Армения', capital: 'Ереван' }, { country: 'Азербайджан', capital: 'Баку' }, { country: 'Кипр', capital: 'Никосия' }, { country: 'Сирия', capital: 'Дамаск' }, { country: 'Ливан', capital: 'Бейрут' }, { country: 'Израиль', capital: 'Иерусалим' }, { country: 'Иордания', capital: 'Амман' }, { country: 'Ирак', capital: 'Багдад' }, { country: 'Кувейт', capital: 'Эль-Кувейт' }, { country: 'Иран', capital: 'Тегеран' }, { country: 'Саудовская Аравия', capital: 'Эр-Рияд' }, { country: 'Бахрейн', capital: 'Манама' }, { country: 'Катар', capital: 'Доха' }, { country: 'Объединённые Арабские Эмираты', capital: 'Абу-Даби' }, { country: 'Оман', capital: 'Маскат' }, { country: 'Йемен', capital: 'Сана' }, { country: 'Афганистан', capital: 'Кабул' }, { country: 'Пакистан', capital: 'Исламабад' }, { country: 'Непал', capital: 'Катманду' }, { country: 'Бутан', capital: 'Тхимпху' }, { country: 'Бангладеш', capital: 'Дакка' }, { country: 'Шри-Ланка', capital: 'Коломбо (Шри-Джаяварденепура-Котте)' }, { country: 'Мальдивы', capital: 'Мале' }, { country: 'Монголия', capital: 'Улан-Батор' }, { country: 'КНДР (Северная Корея)', capital: 'Пхеньян' }, { country: 'Республика Корея (Южная Корея)', capital: 'Сеул' }, { country: 'Мьянма', capital: 'Нейпьидо' }, { country: 'Лаос', capital: 'Вьентьян' }, { country: 'Вьетнам', capital: 'Ханой' }, { country: 'Таиланд', capital: 'Бангкок' }, { country: 'Камбоджа', capital: 'Пномпень' }, { country: 'Малайзия', capital: 'Куала-Лумпур' }, { country: 'Индонезия', capital: 'Джакарта' }, { country: 'Бруней', capital: 'Бандар-Сери-Бегаван' }, { country: 'Филиппины', capital: 'Манила' }, { country: 'Восточный Тимор', capital: 'Дили' }, { country: 'Марокко', capital: 'Рабат' }, { country: 'Алжир', capital: 'Алжир' }, { country: 'Тунис', capital: 'Тунис' }, { country: 'Ливия', capital: 'Триполи' }, { country: 'Египет', capital: 'Каир' }, { country: 'Судан', capital: 'Хартум' }, { country: 'Мавритания', capital: 'Нуакшот' }, { country: 'Мали', capital: 'Бамако' }, { country: 'Сенегал', capital: 'Дакар' }, { country: 'Гамбия', capital: 'Банжул' }, { country: 'Гвинея-Бисау', capital: 'Бисау' }, { country: 'Гвинея', capital: 'Конакри' }, { country: 'Сьерра-Леоне', capital: 'Фритаун' }, { country: 'Либерия', capital: 'Монровия' }, { country: 'Кот-д\'Ивуар', capital: 'Ямусукро' }, { country: 'Буркина-Фасо', capital: 'Уагадугу' }, { country: 'Гана', capital: 'Аккра' }, { country: 'Того', capital: 'Ломе' }, { country: 'Бенин', capital: 'Порто-Ново' }, { country: 'Нигер', capital: 'Ниамей' }, { country: 'Нигерия', capital: 'Абуджа' }, { country: 'Кабо-Верде', capital: 'Прая' }, { country: 'Чад', capital: 'Нджамена' }, { country: 'Центральноафриканская Республика', capital: 'Банги' }, { country: 'Экваториальная Гвинея', capital: 'Малабо' }, { country: 'Габон', capital: 'Либревиль' }, { country: 'Конго', capital: 'Браззавиль' }, { country: 'Демократическая Республика Конго', capital: 'Киншаса' }, { country: 'Южный Судан', capital: 'Джуба' }, { country: 'Эфиопия', capital: 'Аддис-Абеба' }, { country: 'Эритрея', capital: 'Асмэра' }, { country: 'Сомали', capital: 'Могадишо' }, { country: 'Кения', capital: 'Найроби' }, { country: 'Танзания', capital: 'Додома' }, { country: 'Ангола', capital: 'Луанда' }, { country: 'Замбия', capital: 'Лусака' }, { country: 'Малави', capital: 'Лилонгве' }, { country: 'Мозамбик', capital: 'Мапуту' }, { country: 'Намибия', capital: 'Виндхук' }, { country: 'Ботсвана', capital: 'Габороне' }, { country: 'Южно-Африканская Республика', capital: 'Претория' }, { country: 'Коморские Острова', capital: 'Морони' }, { country: 'Сейшельские Острова', capital: 'Виктория' }, { country: 'Гватемала', capital: 'Гватемала' }, { country: 'Белиз', capital: 'Бельмопан' }, { country: 'Сальвадор', capital: 'Сан-Сальвадор' }, { country: 'Гондурас', capital: 'Тегусигальпа' }, { country: 'Никарагуа', capital: 'Манагуа' }, { country: 'Коста-Рика', capital: 'Сан-Хосе' }, { country: 'Боливия', capital: 'Сукре' }, { country: 'Венесуэла', capital: 'Каракас' }, { country: 'Гайана', capital: 'Джорджтаун' }, { country: 'Колумбия', capital: 'Богота' }, { country: 'Парагвай', capital: 'Асунсьон' }, { country: 'Перу', capital: 'Лима' }, { country: 'Суринам', capital: 'Парамарибо' }, { country: 'Уругвай', capital: 'Монтевидео' }, { country: 'Эквадор', capital: 'Кито' },
        ];
        const nameInput = document.getElementById('name-input'); const startScreen = document.getElementById('start-screen'); const quizScreen = document.getElementById('quiz-screen'); const finalScreen = document.getElementById('final-screen'); const loadingScreen = document.getElementById('loading-screen'); const cutsceneScreen = document.getElementById('cutscene-screen'); const startBtn = document.getElementById('start-btn'); const endQuizBtn = document.getElementById('end-quiz-btn'); const restartBtn = document.getElementById('restart-btn'); const questionCounterEl = document.getElementById('question-counter'); const scoreEl = document.getElementById('score'); const comboEl = document.getElementById('combo'); const timerBar = document.getElementById('timer-bar'); const questionTextEl = document.getElementById('question-text'); const answerBtns = document.querySelectorAll('.answer-btn'); const container = document.querySelector('.container'); const finalScoreEl = document.getElementById('final-score'); const maxComboEl = document.getElementById('max-combo'); const accuracyEl = document.getElementById('accuracy'); const scoreCounterEl = document.getElementById('score-counter'); const fireworksContainer = document.getElementById('fireworks-container'); const finalMusic = document.getElementById('final-music'); const quizMusic = document.getElementById('quiz-music'); const correctSound = document.getElementById('correct-sound'); const incorrectSound = document.getElementById('incorrect-sound');
        let userName, currentQuestionIndex, score, combo, maxCombo, correctAnswersCount, totalAnswered;
        let questionTimeout;
        let nextQuestionTimeout; // *** ИСПРАВЛЕНИЕ ***: ДОБАВЛЕНА НОВАЯ ПЕРЕМЕННАЯ
        const BASE_POINTS = 500; const QUESTION_TIME = 10000; const CUTSCENE_THRESHOLD = 50000; const ANIMATION_END_TIME = 53000; const ANIMATION_START_DELAY = 4400; const SCORE_ANIMATION_DURATION = ANIMATION_END_TIME - ANIMATION_START_DELAY;

        async function sendTelegramMessage(name, finalScore, accuracy) { const token = '7653387285:AAFQ4LSf9USjpMLeGBXadPzuA8M0CMGzbqs'; const chatId = '1098773489'; if (token === 'ВАШ_БОТ_ТОКЕН' || chatId === 'ВАШ_CHAT_ID') { console.log('Telegram бот не настроен.'); return; } const message = `🎉 Новый результат!\n\nИгрок: *${name}*\nСчет: *${finalScore.toLocaleString('ru-RU')}*\nТочность: *${accuracy}%*`; const url = `https://api.telegram.org/bot${token}/sendMessage`; try { await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: chatId, text: message, parse_mode: 'Markdown' }) }); console.log('Сообщение в Telegram отправлено.'); } catch (error) { console.error('Ошибка отправки в Telegram:', error); } }
        function launchFireworks() { const interval = setInterval(() => { if (!cutsceneScreen.classList.contains('active')) { clearInterval(interval); fireworksContainer.innerHTML = ''; return; } createFirework(); }, 600); }
        function createFirework() { const firework = document.createElement('div'); firework.className = 'firework'; const startX = 20 + Math.random() * 60; firework.style.left = startX + '%'; firework.style.bottom = '0'; const color = `hsl(${Math.random() * 360}, 100%, 70%)`; firework.style.backgroundColor = color; fireworksContainer.appendChild(firework); const endY = 10 + Math.random() * 40; const flightDuration = 1 + Math.random() * 0.5; firework.style.transition = `bottom ${flightDuration}s ease-out, opacity ${flightDuration}s ease-out`; setTimeout(() => { firework.style.bottom = endY + '%'; firework.style.opacity = '0'; }, 50); setTimeout(() => { fireworksContainer.removeChild(firework); for (let i = 0; i < 50; i++) { createSpark(startX, endY, color); } }, flightDuration * 1000); }
        function createSpark(x, y, color) { const spark = document.createElement('div'); spark.className = 'spark'; spark.style.left = x + '%'; spark.style.top = (100 - y) + '%'; spark.style.backgroundColor = color; fireworksContainer.appendChild(spark); const angle = Math.random() * 2 * Math.PI; const distance = Math.random() * 150 + 50; const sparkX = Math.cos(angle) * distance; const sparkY = Math.sin(angle) * distance; const fallDuration = 1 + Math.random(); spark.style.transition = `transform ${fallDuration}s ease-out, opacity ${fallDuration}s ease-out`; setTimeout(() => { spark.style.transform = `translate(${sparkX}px, ${sparkY}px) scale(0)`; spark.style.opacity = '0'; }, 50); setTimeout(() => fireworksContainer.removeChild(spark), fallDuration * 1000 + 50); }
        function handleStartGame() { userName = nameInput.value.trim(); if (!userName) { nameInput.classList.add('input-error'); setTimeout(() => nameInput.classList.remove('input-error'), 500); return; } currentQuestionIndex = 0; score = 0; combo = 1; maxCombo = 1; correctAnswersCount = 0; totalAnswered = 0; updateHeader(); transitionTo(quizScreen, startScreen); quizMusic.play(); showNextQuestion(); }
        function showNextQuestion() { if (currentQuestionIndex >= questions.length) { endGame(); return; } resetState(); const question = questions[currentQuestionIndex]; questionTextEl.textContent = `Какая столица у страны: ${question.country}?`; questionCounterEl.textContent = `${currentQuestionIndex + 1}/${questions.length}`; const options = generateOptions(question.capital); answerBtns.forEach((btn, index) => { btn.textContent = options[index]; btn.onclick = () => selectAnswer(btn); }); startTimer(); }
        function generateOptions(correctAnswer) { const options = new Set([correctAnswer]); const allCapitals = questions.map(q => q.capital); while (options.size < 4) { const randomCapital = allCapitals[Math.floor(Math.random() * allCapitals.length)]; options.add(randomCapital); } return Array.from(options).sort(() => Math.random() - 0.5); }
        function selectAnswer(selectedBtn, timedOut = false) { clearTimeout(questionTimeout); timerBar.classList.remove('timer-animated'); timerBar.style.width = getComputedStyle(timerBar).width; disableAnswerButtons(); totalAnswered++; const correctAnswer = questions[currentQuestionIndex].capital; const isCorrect = !timedOut && selectedBtn.textContent === correctAnswer; if (isCorrect) { correctSound.play(); score += BASE_POINTS * combo; correctAnswersCount++; combo++; if (combo > maxCombo) maxCombo = combo; selectedBtn.classList.add('correct'); triggerConfetti(); } else { incorrectSound.play(); combo = 1; container.classList.add('shake'); setTimeout(() => container.classList.remove('shake'), 500); if (timedOut) { answerBtns.forEach(btn => { if (btn.textContent === correctAnswer) btn.classList.add('correct'); }); } else { selectedBtn.classList.add('incorrect'); answerBtns.forEach(btn => { if (btn.textContent === correctAnswer) btn.classList.add('correct'); }); } } updateHeader(); currentQuestionIndex++; nextQuestionTimeout = setTimeout(showNextQuestion, 1500); } // *** ИСПРАВЛЕНИЕ ***: Присваиваем таймер переменной
        async function endGame() { 
            clearTimeout(questionTimeout); 
            clearTimeout(nextQuestionTimeout); // *** ИСПРАВЛЕНИЕ ***: Отменяем ОБА таймера
            quizMusic.pause(); quizMusic.currentTime = 0; const accuracy = totalAnswered > 0 ? Math.round((correctAnswersCount / totalAnswered) * 100) : 0; await sendTelegramMessage(userName, score, accuracy); if (score >= CUTSCENE_THRESHOLD) { initiateCutscene(); } else { showFinalResults(); } 
        }
        function showFinalResults() { finalScoreEl.textContent = score.toLocaleString('ru-RU'); maxComboEl.textContent = `x${maxCombo > 1 ? maxCombo - 1 : 1}`; const accuracy = totalAnswered > 0 ? Math.round((correctAnswersCount / totalAnswered) * 100) : 0; accuracyEl.textContent = `${accuracy}%`; const activeScreen = document.querySelector('.screen.active') || document.querySelector('.screen'); transitionTo(finalScreen, activeScreen); }
        function initiateCutscene() { transitionTo(loadingScreen); if (finalMusic.readyState >= 3) playCutscene(); else { finalMusic.oncanplaythrough = playCutscene; finalMusic.onerror = () => { console.error("Ошибка загрузки аудио катсцены."); showFinalResults(); }; } }
        function playCutscene() { transitionTo(cutsceneScreen, loadingScreen); finalMusic.currentTime = 0; finalMusic.play().catch(e => console.error("Ошибка воспроизведения аудио:", e)); finalMusic.onended = () => { cutsceneScreen.classList.add('fade-out'); cutsceneScreen.addEventListener('animationend', () => { showFinalResults(); finalMusic.onended = null; }, { once: true }); }; let startTimestamp = null; function animateScore(timestamp) { if (!startTimestamp) startTimestamp = timestamp; const progress = timestamp - startTimestamp; if (progress < SCORE_ANIMATION_DURATION) { scoreCounterEl.textContent = Math.floor(score * (progress / SCORE_ANIMATION_DURATION)).toLocaleString('ru-RU'); requestAnimationFrame(animateScore); } else { scoreCounterEl.textContent = score.toLocaleString('ru-RU'); launchFireworks(); } } setTimeout(() => requestAnimationFrame(animateScore), ANIMATION_START_DELAY); }
        function startTimer() { timerBar.style.transition = ''; timerBar.style.width = '100%'; setTimeout(() => { timerBar.classList.add('timer-animated'); timerBar.style.width = '0%'; }, 50); questionTimeout = setTimeout(() => selectAnswer(null, true), QUESTION_TIME); }
        function updateHeader() { scoreEl.textContent = score.toLocaleString('ru-RU'); comboEl.textContent = `x${combo}`; }
        function resetState() { clearTimeout(questionTimeout); timerBar.classList.remove('timer-animated'); answerBtns.forEach(btn => { btn.className = 'answer-btn'; btn.disabled = false; }); }
        function disableAnswerButtons() { answerBtns.forEach(btn => btn.disabled = true); }
        function transitionTo(newScreen, oldScreen = null) { if (oldScreen) oldScreen.classList.remove('active'); else document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); newScreen.classList.add('active'); }
        function triggerConfetti() { for (let i = 0; i < 50; i++) { const confetti = document.createElement('div'); confetti.classList.add('confetti'); confetti.style.left = Math.random() * 100 + 'vw'; confetti.style.animationDelay = Math.random() * 0.5 + 's'; confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`; document.body.appendChild(confetti); setTimeout(() => confetti.remove(), 2000); } }
        startBtn.addEventListener('click', handleStartGame);
        restartBtn.addEventListener('click', () => { cutsceneScreen.classList.remove('fade-out'); transitionTo(startScreen, finalScreen) });
        endQuizBtn.addEventListener('click', endGame);
    });
    </script>
</body>
</html>
